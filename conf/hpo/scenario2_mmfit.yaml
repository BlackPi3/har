# Per-scenario, per-dataset search space for Hydra Optuna Sweeper
# Activate with: -m hydra/sweeper=optuna hpo=scenario2_mmfit

# This file declares the search space (params) and the objective.

# Also define the objective to optimize for this space.
hpo:
  metric: val_f1
  mode: maximize

hydra:
  sweeper:
    # Keep sweep-level defaults close to the space so CLI can stay minimal
    direction: ${hpo.mode}
    # Study name with a robust fallback: prefer env STUDY_NAME, else this file's canonical name
    study_name: scenario2_mmfit
    # Store Optuna DB alongside trials inside the repo
    storage: "sqlite:///experiments/hpo/${hpo.study_name}/${hpo.study_name}.db"
    params:
      # Optimizer
      optim.lr: tag(log, interval(1e-5, 1e-2))
      optim.weight_decay: tag(log, interval(1e-6, 1e-2))
      optim.warmup_epochs: choice(0, 3, 5, 8)
      optim.warmup_start_factor: interval(0.05, 0.5)

      # Scenario2-specific loss coefficients
      scenario.alpha: choice(0, 0.1, 1, 10, 100)
      scenario.beta: choice(0, 0.1, 1, 10, 100)
      scenario.gamma: choice(0, 0.1, 1, 10, 100)

      # Data/model coupling (MM-Fit typical ranges)
      data.sensor_window_length: choice(400, 450, 500, 550)
      data.stride_seconds: choice(0.1, 0.15, 0.2)
      model.feature_extractor.n_filters: range(8, 32, 4)
      model.feature_extractor.filter_size: range(3, 9, 2)
      model.regressor.joint_hidden_channels: choice([32, 32, 32, 16], [48, 48, 32, 16], [64, 64, 32, 32])
      model.regressor.joint_kernel_sizes: choice([3, 3, 3, 1], [5, 5, 5, 1], [7, 5, 3, 1])
      model.regressor.joint_dilations: choice([1, 2, 4, 1], [1, 3, 5, 1])
      model.regressor.joint_dropouts: choice([0.0, 0.1, 0.1, 0.1], [0.0, 0.2, 0.2, 0.2], [0.1, 0.3, 0.3, 0.3])
      model.regressor.temporal_hidden_channels: choice(16, 24, 32, 48)
      model.regressor.temporal_kernel_size: choice(3, 5, 7)
      model.regressor.temporal_dilation: choice(1, 2, 3)
      model.regressor.temporal_dropout: interval(0.05, 0.3)
      model.regressor.fc_hidden: choice(0, 64, 128)
      model.regressor.fc_dropout: interval(0.0, 0.4)
      model.regressor.use_batch_norm: choice(true, false)

  sweep:
    # Place all trials under a unified per-study directory
    dir: "experiments/hpo/${hpo.study_name}/trials"
    subdir: trial_${hydra.job.num}
